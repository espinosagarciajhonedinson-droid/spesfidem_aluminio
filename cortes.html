<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE CORTES - SPESFIDEM ALUMINIO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --excel-bg: #fff;
            --excel-border: #000;
            --excel-orange: #f6b26b;
            --excel-red: #cc0000;
            --excel-yellow: #f1c232;
            --sidebar-width: 320px;
        }

        body {
            font-family: 'Calibri', 'Arial', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background: #f0f0f0;
            overflow: hidden;
        }

        /* Sidebar con Buscador */
        .sidebar {
            width: var(--sidebar-width);
            background: #0f172a;
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .sidebar-header {
            padding: 25px 20px;
            background: #1e293b;
            border-bottom: 2px solid #3b82f6;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1.1rem;
            letter-spacing: 1px;
            color: #3b82f6;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            border-radius: 6px;
            border: none;
            box-sizing: border-box;
            background: #334155;
            color: white;
            font-size: 0.9rem;
        }

        .system-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .system-item {
            padding: 14px 12px;
            cursor: pointer;
            border-radius: 6px;
            border-bottom: 1px solid #1e293b;
            transition: 0.2s;
            font-size: 0.85rem;
            font-weight: 600;
            color: #cbd5e1;
        }

        .system-item:hover {
            background: #334155;
            color: white;
        }

        .system-item.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }

        /* √Årea Principal */
        .main {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* Toolbar */
        .toolbar {
            padding: 15px 30px;
            background: #fff;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: space-between;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .btn-print {
            background: #1d6f42;
            color: white;
        }

        .btn-print:hover {
            background: #155231;
        }

        .btn-back {
            background: #64748b;
            color: white;
            text-decoration: none;
        }

        /* Hoja de C√°lculo (Estilo Excel Puro) */
        .sheet {
            padding: 40px;
            max-width: 1050px;
            margin: 0 auto;
            background: white;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid var(--excel-border);
        }

        .excel-table td,
        .excel-table th {
            border: 1px solid #000;
            padding: 6px 10px;
            font-size: 14px;
            color: #000;
        }

        /* T√≠tulo Rojo */
        .title-row {
            color: var(--excel-red);
            font-weight: 900;
            font-size: 24px;
            text-transform: uppercase;
            text-align: center;
            height: 50px;
            background: #fff;
        }

        /* Labels y Celdas Especiales */
        .label-cell {
            background: var(--excel-orange);
            font-weight: 900;
            width: 180px;
            text-transform: uppercase;
            font-size: 13px;
        }

        .input-value-cell {
            background: var(--excel-yellow);
            font-weight: 900;
            width: 160px;
            text-align: center;
            font-size: 20px;
        }

        .unit-cell {
            font-weight: 900;
            background: #fff;
            text-align: left;
        }

        .header-row {
            color: var(--excel-red);
            font-weight: 900;
            text-align: center;
            text-transform: uppercase;
            background: #fff;
        }

        .header-row td {
            padding: 8px 10px;
            border-width: 2px;
        }

        .cat-label {
            font-weight: 900;
            text-align: center;
            background: #fff;
            vertical-align: middle;
            font-size: 15px;
        }

        .desc-cell {
            font-weight: 600;
            text-transform: uppercase;
        }

        .val-cell {
            text-align: center;
            font-weight: 800;
            font-size: 15px;
        }

        .measure-val {
            color: #000;
            font-weight: 900;
            font-size: 18px;
        }

        input.table-input {
            width: 100%;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            font-weight: inherit;
            outline: none;
            text-align: inherit;
            color: inherit;
        }

        /* Loader */
        #loader {
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(59, 130, 246, 0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media print {

            .sidebar,
            .toolbar {
                display: none !important;
            }

            .main {
                margin: 0;
                overflow: visible;
            }

            .sheet {
                padding: 0;
                box-shadow: none;
                max-width: 100%;
            }
        }
    </style>
</head>

<body>

    <div id="loader">
        <div class="spinner"></div>
        <h2 style="font-family: 'Outfit'; font-weight: 300; letter-spacing: 2px;">SINCRONIZANDO <span
                style="font-weight: 800; color:#3b82f6">SOLUCI√ìN DE CORTES...</span></h2>
        <p id="progressTxt" style="margin-top: 1rem; color: #94a3b8; font-weight: 600;">Cargando base de datos t√©cnica
        </p>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>CENTRO DE PRODUCCI√ìN</h2>
            <input type="text" class="search-box" id="search" placeholder="üîç Buscar sistema (Ej: 8025, 744)..."
                oninput="filterSystems()">
        </div>
        <div class="system-list" id="sys-list">
            <!-- Sistemas cargados de Excel -->
        </div>
    </div>

    <div class="main">
        <div class="toolbar">
            <a href="admin.html" class="btn btn-back">
                <i class="fas fa-arrow-left"></i> VOLVER AL PANEL
            </a>
            <div style="font-weight: 800; color: #1e293b; font-size: 1.1rem; text-transform: uppercase;">
                <i class="fas fa-file-invoice" style="color:#3b82f6"></i> Orden de Producci√≥n
            </div>
            <button class="btn btn-print" onclick="window.print()">
                <i class="fas fa-print"></i> IMPRIMIR CORTES
            </button>
        </div>

        <div class="sheet">
            <table class="excel-table" id="master-table">
                <tr>
                    <td colspan="5" class="title-row" id="sys-title">NOMBRE DEL SISTEMA</td>
                </tr>
                <tr>
                    <td class="label-cell">ALTURA TOTAL</td>
                    <td class="input-value-cell">
                        <input type="number" id="h-total" class="table-input" value="0" step="0.1" oninput="recalc()">
                    </td>
                    <td colspan="3" class="unit-cell">CENTIMETROS</td>
                </tr>
                <tr>
                    <td class="label-cell">ANCHO TOTAL</td>
                    <td class="input-value-cell">
                        <input type="number" id="w-total" class="table-input" value="0" step="0.1" oninput="recalc()">
                    </td>
                    <td colspan="3" class="unit-cell">CENTIMETROS</td>
                </tr>
                <tr>
                    <td class="label-cell">REF. ALUMINIO</td>
                    <td colspan="4" id="ref-alu" style="font-weight: 800;">-</td>
                </tr>
                <tr>
                    <td class="label-cell">REF. ACRILICO</td>
                    <td colspan="4" id="ref-acr" style="font-weight: 800;">-</td>
                </tr>
                <tr class="header-row">
                    <td style="width: 25%;">DESCRIPCION</td>
                    <td style="width: 20%;">REF.</td>
                    <td style="width: 20%;">MEDIDA cm</td>
                    <td style="width: 15%;">CANT / UND</td>
                    <td style="width: 20%;">CORTE GRADOS</td>
                </tr>
                <tbody id="table-body">
                    <!-- Filas din√°micas -->
                </tbody>

                <!-- Fechas de Control -->
                <tr>
                    <td colspan="5" style="border:none; height:20px;"></td>
                </tr>
                <tr>
                    <td class="label-cell" style="background:#f3f4f6;">FECHA DE ORDEN</td>
                    <td colspan="2"><input type="text" id="fecha-orden" class="table-input" placeholder="DD/MM/AAAA">
                    </td>
                    <td class="label-cell" style="background:#f3f4f6;">FECHA DE ENTREGA</td>
                    <td><input type="text" id="fecha-entrega" class="table-input" placeholder="DD/MM/AAAA"></td>
                </tr>
                <tr>
                    <td class="label-cell" style="background:#f3f4f6; height:60px;">OBSERVACIONES</td>
                    <td colspan="2"><textarea class="table-input" style="height:100%; resize:none;"></textarea></td>
                    <td class="label-cell" style="background:#f3f4f6;">ENCARGADO</td>
                    <td><input type="text" class="table-input"></td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        let systems = [];
        let activeIdx = -1;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadExcel();
            document.getElementById('loader').style.display = 'none';

            // Autopoblar fecha hoy
            const hoy = new Date().toLocaleDateString('es-ES');
            document.getElementById('fecha-orden').value = hoy;
        });

        async function loadExcel() {
            try {
                const resp = await fetch('assets/documents/tabla_descuentos.xlsx?v=' + Date.now());
                const buf = await resp.arrayBuffer();
                const wb = XLSX.read(new Uint8Array(buf), { type: 'array' });

                wb.SheetNames.forEach(name => {
                    const ws = wb.Sheets[name];
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                    if (rows.length < 5) return;

                    const sys = {
                        key: name,
                        displayName: rows[1] ? (rows[1][0] || name) : name,
                        hBase: parseFloat(rows[2] ? rows[2][2] : 0),
                        wBase: parseFloat(rows[3] ? rows[3][2] : 0),
                        refAlu: rows[4] ? rows[4][2] : '-',
                        refAcr: rows[5] ? rows[5][2] : '-',
                        items: []
                    };

                    let currentCat = "";
                    // Procesar desde fila 9
                    for (let i = 8; i < rows.length; i++) {
                        const r = rows[i];
                        if (!r[1] && !r[0]) continue;

                        if (r[0] && r[0].toString().trim() !== "") {
                            currentCat = r[0].toString().trim();
                        }

                        const mValue = parseFloat(r[3]) || parseFloat(r[4]) || 0;
                        let mType = 'fijo', mDiff = 0;

                        if (mValue > 0) {
                            const dH = Math.abs(sys.hBase - mValue);
                            const dW = Math.abs(sys.wBase - mValue);
                            if (dH < dW && dH < 100) { mType = 'h'; mDiff = sys.hBase - mValue; }
                            else if (dW < 100) { mType = 'w'; mDiff = sys.wBase - mValue; }
                        }

                        sys.items.push({
                            cat: currentCat,
                            desc: r[1] || "",
                            ref: r[2] || "-",
                            base: mValue,
                            type: mType,
                            diff: mDiff,
                            cant: r[5] || "1",
                            corte: r[6] || "-"
                        });
                    }
                    systems.push(sys);
                });

                renderSidebar();
                if (systems.length > 0) selectSystem(0);

            } catch (e) {
                console.error(e);
                alert("Error: Aseg√∫rese de que assets/documents/tabla_descuentos.xlsx exista.");
            }
        }

        function renderSidebar() {
            const list = document.getElementById('sys-list');
            list.innerHTML = systems.map((s, i) => `
            <div class="system-item" id="sys-${i}" onclick="selectSystem(${i})">
                ${s.displayName}
            </div>
        `).join('');
        }

        function filterSystems() {
            const q = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('.system-item').forEach((item, i) => {
                item.style.display = systems[i].displayName.toLowerCase().includes(q) ? 'block' : 'none';
            });
        }

        function selectSystem(idx) {
            document.querySelectorAll('.system-item').forEach(it => it.classList.remove('active'));
            document.getElementById(`sys-${idx}`).classList.add('active');
            activeIdx = idx;

            const s = systems[idx];
            document.getElementById('sys-title').textContent = s.displayName;
            document.getElementById('h-total').value = s.hBase;
            document.getElementById('w-total').value = s.wBase;
            document.getElementById('ref-alu').textContent = s.refAlu;
            document.getElementById('ref-acr').textContent = s.refAcr;

            recalc();
        }

        function recalc() {
            if (activeIdx === -1) return;
            const h = parseFloat(document.getElementById('h-total').value) || 0;
            const w = parseFloat(document.getElementById('w-total').value) || 0;
            const s = systems[activeIdx];

            const body = document.getElementById('table-body');
            body.innerHTML = '';

            let lastCat = "";
            s.items.forEach(item => {
                let finalMeasure = item.base;
                if (item.type === 'h') finalMeasure = h - item.diff;
                else if (item.type === 'w') finalMeasure = w - item.diff;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td class="desc-cell">${item.cat ? '<span style="color:#cc0000; font-weight:900;">' + item.cat + ':</span> ' : ''}${item.desc}</td>
                <td class="val-cell">${item.ref}</td>
                <td class="val-cell measure-val">${finalMeasure.toFixed(1)}</td>
                <td class="val-cell">${item.cant}</td>
                <td class="val-cell">${item.corte}</td>
            `;
                body.appendChild(tr);
            });
        }
    </script>

</body>

</html>