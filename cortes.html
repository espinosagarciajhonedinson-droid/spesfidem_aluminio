<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Cortes - Spesfidem Aluminio</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --excel-green: #217346;
            --excel-light: #f3f3f3;
            --excel-border: #d0d0d0;
            --excel-blue: #cfe2f3;
            --dark-bg: #1e1e1e;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #fff;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar similar to Admin Panel */
        .sidebar {
            width: var(--sidebar-width);
            background: #0f172a;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #1e293b;
        }

        .logo-text {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .search-box {
            padding: 1rem;
            background: #1e293b;
        }

        #search {
            width: 100%;
            padding: 10px;
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .system-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .system-item {
            padding: 12px 1.5rem;
            cursor: pointer;
            border-bottom: 1px solid #1e293b;
            color: #94a3b8;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .system-item:hover {
            background: #1e293b;
            color: #fff;
        }

        .system-item.active {
            background: var(--excel-green);
            color: white;
            font-weight: bold;
            border-left: 4px solid #4ade80;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid #1e293b;
        }

        .btn-back {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px;
            background: #ef4444;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
            gap: 8px;
            transition: background 0.2s;
        }

        .btn-back:hover {
            background: #dc2626;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: #f8fafc;
            /* Keep light background for readability of the table */
            color: #1e293b;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .inputs-row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: bold;
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .input-group input {
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            width: 100px;
            font-size: 1rem;
            font-weight: 600;
        }

        .btn-calc {
            padding: 10px 25px;
            background: var(--excel-green);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 6px -1px rgba(33, 115, 70, 0.3);
            transition: transform 0.1s;
        }

        .btn-calc:active {
            transform: scale(0.98);
        }

        .ref-info {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #475569;
        }

        .ref-tag {
            background: #e2e8f0;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Excel Table Styling */
        .table-container {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            border: 1px solid var(--excel-border);
        }

        .excel-table th,
        .excel-table td {
            border: 1px solid var(--excel-border);
            padding: 8px;
            text-align: center;
        }

        .header-row td {
            background: var(--excel-green);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .group-label {
            font-weight: bold;
            text-align: left;
            background: #f1f5f9;
            width: 140px;
            color: #334155;
        }

        .val-cell {
            background: #fff;
            color: #0f172a;
        }
    </style>
</head>

<body>

    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo-text">Spesfidem <span style="color:var(--excel-green);">Calc</span></div>
        </div>
        <div class="search-box">
            <input type="text" id="search" placeholder="Buscar sistema..." onkeyup="filterSystems()">
        </div>
        <ul class="system-list" id="sys-list">
            <!-- Loaded dynamically -->
        </ul>
        <div class="sidebar-footer">
            <a href="admin.html" class="btn-back">
                <i class="fas fa-arrow-left"></i> Volver al Admin
            </a>
        </div>
    </div>

    <!-- Main Calculation Area -->
    <div class="main-content">

        <div class="top-bar">
            <div>
                <h2 style="margin:0; color:#0f172a; font-size:1.5rem;" id="top-name">Seleccione un sistema</h2>
                <div class="ref-info">
                    <span>Aluminio: <span id="lbl-ref-alu" class="ref-tag">-</span></span>
                    <span>Vidrio: <span id="lbl-ref-vid" class="ref-tag">-</span></span>
                </div>
            </div>

            <div class="inputs-row">
                <div class="input-group">
                    <label>Ancho (cm)</label>
                    <input type="number" id="inp-w" value="100" step="0.1" onchange="runCalculation()" />
                </div>
                <div class="input-group">
                    <label>Altura (cm)</label>
                    <input type="number" id="inp-h" value="200" step="0.1" onchange="runCalculation()" />
                </div>
                <div class="input-group">
                    <label>Cantidad</label>
                    <input type="number" id="inp-q" value="1" min="1" onchange="runCalculation()" />
                </div>
                <button class="btn-calc" onclick="runCalculation()">
                    <i class="fas fa-calculator" style="margin-right:8px;"></i> CALCULAR
                </button>
            </div>
        </div>

        <div class="table-container">
            <h3
                style="margin-top:0; color:#334155; border-bottom:2px solid #e2e8f0; padding-bottom:10px; margin-bottom:15px;">
                Despiece de Materiales
            </h3>
            <table class="excel-table">
                <thead>
                    <tr class="header-row">
                        <td colspan="2" style="width: 35%;">DESCRIPCION</td>
                        <td style="width: 15%;">REF.</td>
                        <td colspan="2" style="width: 30%;">MEDIDAS EN CENTIMETROS</td>
                        <td style="width: 10%;">CANT UND</td>
                        <td style="width: 10%;">ANGULO CORTE</td>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Rows injected via JS -->
                </tbody>
            </table>
        </div>

    </div>

    <script>
        let rawSystems = [];
        let currentActiveIdx = -1;

        window.onload = function () {
            initExcelEngine();
        };

        async function initExcelEngine() {
            try {
                // Using the known existing file in assets
                const resp = await fetch('assets/documents/tabla_descuentos.xlsx?v=' + Date.now());
                if (!resp.ok) throw new Error("No se encontrÃ³ el archivo Excel en assets/documents/");

                const data = await resp.arrayBuffer();
                const wb = XLSX.read(new Uint8Array(data), { type: 'array', cellFormula: true });

                wb.SheetNames.forEach(sheetName => {
                    const ws = wb.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                    if (rows.length < 5) return;

                    // Determine System Name and Filter Bad Names
                    let candidateName = null;
                    if (rows[0] && rows[0].find(c => c && c.toString().trim() !== "")) {
                        candidateName = rows[0].find(c => c && c.toString().trim() !== "").toString();
                    } else if (rows[1] && rows[1].find(c => c && c.toString().trim() !== "")) {
                        candidateName = rows[1].find(c => c && c.toString().trim() !== "").toString();
                    } else {
                        candidateName = sheetName;
                    }

                    const invalidNames = ["ALTURA", "ANCHO", "CANTIDAD", "REF. ALUMINIO", "MEDIDAS", "PRECIO"];
                    if (invalidNames.includes(candidateName.toUpperCase())) {
                        candidateName = sheetName;
                    }

                    const sys = {
                        name: candidateName,
                        hRef: null, wRef: null, qRef: null,
                        hBase: 0, wBase: 0,
                        refAlu: (rows[5] && rows[5][2] ? rows[5][2] : '-').toString(),
                        refVid: (rows[6] && rows[6][2] ? rows[6][2] : '-').toString(),
                        cells: {},
                        materialRows: []
                    };

                    // Store all cells
                    Object.keys(ws).forEach(addr => {
                        if (addr[0] === '!') return;
                        const cell = ws[addr];
                        sys.cells[addr] = { val: cell.v || 0, formula: cell.f || null };
                    });

                    // Detect inputs (Loop to scan dynamic columns for validation logic)
                    for (let r = 0; r < 8; r++) {
                        (rows[r] || []).forEach((cVal, c) => {
                            const txt = cVal ? cVal.toString().toUpperCase() : "";
                            if (txt.includes("ALTURA") || txt.includes("ANCHO") || txt.includes("CANTIDAD")) {
                                for (let offset = 1; offset <= 5; offset++) {
                                    const val = rows[r][c + offset];
                                    if (val !== undefined) {
                                        const cellAddr = XLSX.utils.encode_cell({ r: r, c: c + offset });
                                        if (txt.includes("ALTURA")) {
                                            sys.hRef = cellAddr;
                                            sys.hBase = parseFloat(val) || 0;
                                        } else if (txt.includes("ANCHO")) {
                                            sys.wRef = cellAddr;
                                            sys.wBase = parseFloat(val) || 0;
                                        } else if (txt.includes("CANTIDAD")) {
                                            sys.qRef = cellAddr;
                                        }
                                        break;
                                    }
                                }
                            }
                        });
                    }
                    // Defaults if detection failed
                    if (!sys.hRef) sys.hRef = "D3";
                    if (!sys.wRef) sys.wRef = "D4";
                    if (!sys.qRef) sys.qRef = "D5";

                    // === STRICT GRID COLUMN MAPPING LOGIC ===
                    const headerRowIdx = 8;
                    const headerRow = rows[headerRowIdx] || [];
                    const colIdx = { group: 0, desc: 1, ref: 2, meas1: 3, meas2: 4, meas3: 5, cant: 6, angle: 7 };

                    // 1. Anchor on "REF" column (Standardizes varied layouts)
                    let refCol = -1;
                    headerRow.forEach((val, c) => {
                        if (!val) return;
                        const txt = val.toString().toUpperCase();
                        if (txt.includes("REF") && !txt.includes("VIDRIO") && !txt.includes("ALU")) {
                            refCol = c;
                        }
                    });

                    if (refCol !== -1) {
                        colIdx.ref = refCol;
                        colIdx.desc = refCol - 1;
                        colIdx.group = refCol - 2;
                        colIdx.meas1 = refCol + 1;
                        colIdx.meas2 = refCol + 2;

                        // Scan forward for Quantity/Angle
                        for (let c = refCol + 3; c < headerRow.length; c++) {
                            const txt = (headerRow[c] || "").toString().toUpperCase();
                            if (txt.includes("CANT") || txt.includes("UND")) colIdx.cant = c;
                            if (txt.includes("ANGUL") || txt.includes("CORTE") || txt.includes("GRADO")) colIdx.angle = c;
                        }
                    }

                    // 2. Map Rows (Strict: No skipping of headers like "ALTURA")
                    let lastGroup = "";
                    for (let i = 9; i < rows.length; i++) {
                        const rData = rows[i];

                        const hasDesc = (colIdx.desc >= 0 && rData[colIdx.desc]);
                        const hasRef = (rData[colIdx.ref] !== undefined && rData[colIdx.ref] !== "" && rData[colIdx.ref] !== null);
                        const hasVal1 = (rData[colIdx.meas1] !== undefined && rData[colIdx.meas1] !== "" && rData[colIdx.meas1] !== null);
                        const hasVal2 = (rData[colIdx.meas2] !== undefined && rData[colIdx.meas2] !== "" && rData[colIdx.meas2] !== null);

                        // Robust Empaque/Accessory Scanning
                        let anyRightVal = false;
                        let rightValCol = -1;

                        // Check explicit "EMPAQUE" keywords
                        const isEmpaque = (rData[colIdx.desc] || "").toString().toUpperCase().includes("EMPAQUE") ||
                            (rData[0] || "").toString().toUpperCase().includes("EMPAQUE") ||
                            (rData[0] || "").toString().toUpperCase().includes("ACCESORIOS");

                        if (!hasVal1 && !hasVal2) {
                            // Scan columns right of Meas2
                            for (let c = colIdx.meas2 + 1; c < colIdx.cant; c++) {
                                if (rData[c] !== undefined && rData[c] !== "" && rData[c] !== null) {
                                    anyRightVal = true;
                                    rightValCol = c;
                                    break;
                                }
                            }
                        }

                        if (!hasDesc && !hasRef && !hasVal1 && !hasVal2 && !anyRightVal) continue;

                        let groupVal = "";
                        if (colIdx.group >= 0) {
                            const rawG = rData[colIdx.group];
                            if (rawG && isNaN(parseFloat(rawG))) {
                                groupVal = rawG.toString().trim();
                                lastGroup = groupVal;
                            }
                        }
                        if (!groupVal) groupVal = lastGroup;

                        let usedAddr1 = XLSX.utils.encode_cell({ r: i, c: colIdx.meas1 });
                        let usedAddr2 = XLSX.utils.encode_cell({ r: i, c: colIdx.meas2 });

                        // Fix for Empaque/Accessories: Map floating value
                        if (anyRightVal && !hasVal1) {
                            usedAddr2 = XLSX.utils.encode_cell({ r: i, c: rightValCol });
                        }

                        const m = {
                            group: groupVal,
                            desc: (colIdx.desc >= 0 ? rData[colIdx.desc] : "") || "",
                            ref: (rData[colIdx.ref] || "-").toString(),

                            addr1: usedAddr1,
                            addr2: usedAddr2,

                            cant: (rData[colIdx.cant] || "").toString(),
                            corte: (rData[colIdx.angle] || "").toString(),

                            isGlass: lastGroup.toUpperCase().includes("VIDRIO") || (groupVal.toUpperCase().includes("VIDRIO")),
                            isHeaderRow: (rData[colIdx.meas1] || "").toString().includes("ALTURA")
                        };
                        sys.materialRows.push(m);
                    }
                    rawSystems.push(sys);
                });

                renderSidebar();
                if (rawSystems.length > 0) selectIdx(0);

            } catch (e) {
                console.error(e);
                alert("Error cargando calculadora maestra: " + e.message);
            }
        }

        function renderSidebar() {
            const list = document.getElementById('sys-list');
            list.innerHTML = rawSystems.map((s, i) => `<li class="system-item" id="sys-li-${i}" onclick="selectIdx(${i})">${s.name}</li>`).join('');
        }

        function filterSystems() {
            const q = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('.system-item').forEach((li, i) => {
                li.style.display = rawSystems[i].innerText.toLowerCase().includes(q) ? 'block' : 'none';
            });
        }

        function selectIdx(i) {
            document.querySelectorAll('.system-item').forEach(li => li.classList.remove('active'));
            const selected = document.getElementById(`sys-li-${i}`);
            if (selected) selected.classList.add('active');

            currentActiveIdx = i;
            const s = rawSystems[i];

            document.getElementById('top-name').innerText = s.name;
            document.getElementById('inp-h').value = s.hBase;
            document.getElementById('inp-w').value = s.wBase;
            document.getElementById('inp-q').value = 1;

            document.getElementById('lbl-ref-alu').innerText = s.refAlu;
            document.getElementById('lbl-ref-vid').innerText = s.refVid;

            runCalculation();
        }

        function runCalculation() {
            if (currentActiveIdx === -1) return;
            const hVal = parseFloat(document.getElementById('inp-h').value) || 0;
            const wVal = parseFloat(document.getElementById('inp-w').value) || 0;
            const qVal = parseFloat(document.getElementById('inp-q').value) || 1;

            const s = rawSystems[currentActiveIdx];
            const state = {};
            // Low-perf Deep Clone for cell states, sufficient for this scale
            Object.keys(s.cells).forEach(addr => state[addr] = { ...s.cells[addr] });

            if (state[s.hRef]) state[s.hRef].val = hVal;
            if (state[s.wRef]) state[s.wRef].val = wVal;
            if (state[s.qRef]) state[s.qRef].val = qVal;

            // iterative resolution for dependencies
            for (let pass = 0; pass < 5; pass++) {
                Object.keys(state).forEach(addr => {
                    const cell = state[addr];
                    if (cell.formula) cell.val = evalExcelFormula(cell.formula, state);
                });
            }

            const body = document.getElementById('table-body');
            body.innerHTML = '';
            let currentGrp = "";

            s.materialRows.forEach(m => {
                const tr = document.createElement('tr');

                // Group
                let groupCellHTML = "";
                if (m.group !== currentGrp) {
                    currentGrp = m.group;
                    const isVidrioGroup = m.group.toUpperCase().includes("VIDRIO");
                    groupCellHTML = `<td class="group-label" style="${isVidrioGroup ? 'background:#d9e3f0; color:#2c5282;' : ''}">${m.group}</td>`;
                } else {
                    groupCellHTML = `<td style="border-top:none; border-bottom:none; background:${m.group.toUpperCase().includes("VIDRIO") ? '#d9e3f0' : 'white'};"></td>`;
                }

                // Values
                let val1 = state[m.addr1] ? state[m.addr1].val : "";
                let val2 = state[m.addr2] ? state[m.addr2].val : "";

                const fmt = (v) => (typeof v === 'number' ? Number(v).toFixed(1) : v);

                if (state[m.addr1] && typeof state[m.addr1].val === 'string') val1 = state[m.addr1].val;
                if (state[m.addr2] && typeof state[m.addr2].val === 'string') val2 = state[m.addr2].val;

                // Headers Styling
                const isHeaderVal1 = val1.toString().toUpperCase().includes("ALTURA") || val1.toString().toUpperCase().includes("ANCHO");
                const style1 = isHeaderVal1 ? "color:#1e3a8a; font-weight:bold; background:#cfe2f3;" : "";

                const isHeaderVal2 = val2.toString().toUpperCase().includes("ALTURA") || val2.toString().toUpperCase().includes("ANCHO");
                const style2 = isHeaderVal2 ? "color:#1e3a8a; font-weight:bold; background:#cfe2f3;" : "";

                const descStyle = (m.isGlass && m.desc) ? "font-weight:bold;" : "";

                tr.innerHTML = `
                    ${groupCellHTML}
                    <td style="${descStyle} background:${m.isGlass ? '#d9e3f0' : '#fff'};">${m.desc}</td>
                    <td class="val-cell">${m.ref}</td>
                    <td class="val-cell" style="${style1}">${fmt(val1)}</td>
                    <td class="val-cell" style="${style2}">${fmt(val2)}</td>
                    <td class="val-cell">${m.cant}</td>
                    <td class="val-cell">${m.corte}</td>
                `;
                body.appendChild(tr);
            });
        }

        function evalExcelFormula(formula, state) {
            try {
                let clean = formula.startsWith('=') ? formula.substring(1) : formula;
                let mathStr = clean.replace(/\$?[A-Z]+\$?[0-9]+/g, (match) => {
                    const addr = match.replace(/\$/g, "");
                    return (state[addr] ? "(" + state[addr].val + ")" : "0");
                });
                mathStr = mathStr.replace(/([0-9.]+)%/g, "($1/100)");
                return Function('"use strict"; return (' + mathStr + ')')();
            } catch (e) {
                return 0;
            }
        }
    </script>
</body>

</html>